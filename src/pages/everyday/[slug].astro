---
/**
 * Single Everyday Post Page
 *
 * Dynamic route that displays a single everyday post.
 * Uses [slug] parameter to fetch the correct post from WordPress.
 *
 * Media priority: embed (video) > audio > image
 */
import Base from '../../layouts/Base.astro';
import { getEverydayBySlug, getAllEverydayNavInfo } from '../../lib/api';
import type { PostNavInfo } from '../../lib/api';

// Generate static pages for all everyday posts at build time
export async function getStaticPaths() {
  const allPosts = await getAllEverydayNavInfo();

  return allPosts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      // Previous = newer post (lower index), Next = older post (higher index)
      prev: index > 0 ? allPosts[index - 1] : null,
      next: index < allPosts.length - 1 ? allPosts[index + 1] : null,
    },
  }));
}

interface Props {
  prev: PostNavInfo | null;
  next: PostNavInfo | null;
}

// Get props from getStaticPaths
const { prev, next } = Astro.props;

// Get the post for this page
const { slug } = Astro.params;
const post = await getEverydayBySlug(slug!);

// 404 if post not found
if (!post) {
  return Astro.redirect('/404');
}

const { toolset_fields } = post;

// Determine which media to show (priority: embed > audio > image)
const hasEmbed = Boolean(toolset_fields.embed);
const hasAudio = Boolean(toolset_fields.audio);
const hasImage = Boolean(toolset_fields.image);

// Format the date
const formattedDate = new Date(post.date).toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
  year: 'numeric'
});

// Strip HTML tags from title (WordPress sends it as rendered HTML)
const title = post.title.rendered.replace(/<[^>]*>/g, '');
---

<Base title={title} description={`Everyday post: ${title}`}>
  <article class="max-w-4xl mx-auto p-4">

    {/* Header */}
    <header class="mb-6">
      <a href="/everyday" class="text-teal-600 hover:text-teal-500 text-sm mb-2 inline-block">
        &larr; Back to Everyday
      </a>
      <h1 class="text-yellow-500 text-2xl md:text-3xl font-bold">{title}</h1>
      <time class="text-teal-600 text-sm" datetime={post.date}>{formattedDate}</time>
    </header>

    {/* Main Media */}
    <div class="mb-6">
      {hasEmbed ? (
        <!-- Video embed (YouTube, Vimeo, etc.) -->
        <div class="aspect-video" set:html={toolset_fields.embed} />
      ) : hasAudio ? (
        <!-- Audio with image background -->
        <div class="relative">
          {hasImage && (
            <img
              src={toolset_fields.image}
              alt={title}
              class="w-full"
            />
          )}
          <div class="mt-4" set:html={toolset_fields.audio} />
        </div>
      ) : hasImage ? (
        <!-- Image only -->
        <img
          src={toolset_fields.image}
          alt={title}
          class="w-full"
        />
      ) : (
        <!-- No media fallback -->
        <div class="bg-teal-900 aspect-video flex items-center justify-center text-teal-600">
          No media available
        </div>
      )}
    </div>

    {/* Post content (if any) */}
    {post.content.rendered && (
      <div
        class="prose prose-invert prose-teal max-w-none"
        set:html={post.content.rendered}
      />
    )}

    {/* Prev/Next Navigation */}
    <nav class="mt-8 pt-6 border-t border-teal-800 flex justify-between gap-4">
      {prev ? (
        <a href={`/everyday/${prev.slug}`} class="group flex-1 text-left">
          <span class="text-teal-600 text-xs uppercase">Previous</span>
          <div class="text-teal-500 group-hover:text-yellow-500 transition-colors truncate">
            &larr; {prev.title}
          </div>
        </a>
      ) : (
        <div class="flex-1" />
      )}

      {next ? (
        <a href={`/everyday/${next.slug}`} class="group flex-1 text-right">
          <span class="text-teal-600 text-xs uppercase">Next</span>
          <div class="text-teal-500 group-hover:text-yellow-500 transition-colors truncate">
            {next.title} &rarr;
          </div>
        </a>
      ) : (
        <div class="flex-1" />
      )}
    </nav>

  </article>
</Base>

---
/**
 * Single Work Post Page
 *
 * Displays a portfolio/project with image gallery and content.
 */
import Base from '../../layouts/Base.astro';
import { getWorkPosts, getWorkBySlug } from '../../lib/api';

// Generate static pages for all work posts
export async function getStaticPaths() {
  const posts = await getWorkPosts();

  return posts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      prev: index > 0 ? {
        slug: posts[index - 1].slug,
        title: posts[index - 1].title.rendered.replace(/<[^>]*>/g, ''),
      } : null,
      next: index < posts.length - 1 ? {
        slug: posts[index + 1].slug,
        title: posts[index + 1].title.rendered.replace(/<[^>]*>/g, ''),
      } : null,
    },
  }));
}

interface NavInfo {
  slug: string;
  title: string;
}

interface Props {
  prev: NavInfo | null;
  next: NavInfo | null;
}

const { prev, next } = Astro.props;
const { slug } = Astro.params;
const post = await getWorkBySlug(slug!);

if (!post) {
  return Astro.redirect('/404');
}

const title = post.title.rendered.replace(/<[^>]*>/g, '');
const images = post.toolset_fields.work_images || [];
---

<Base title={title} description={post.excerpt.rendered.replace(/<[^>]*>/g, '').trim()}>
  <article class="max-w-5xl mx-auto p-4">

    {/* Header */}
    <header class="mb-6">
      <a href="/work" class="text-teal-600 hover:text-teal-500 text-sm mb-2 inline-block">
        &larr; Back to Work
      </a>
      <h1 class="text-yellow-500 text-2xl md:text-4xl font-bold">{title}</h1>
    </header>

    {/* Image Gallery */}
    {images.length > 0 && (
      <div class="mb-8 space-y-4">
        {images.map((src, index) => (
          <img
            src={src}
            alt={`${title} - Image ${index + 1}`}
            class="w-full"
            loading={index === 0 ? 'eager' : 'lazy'}
          />
        ))}
      </div>
    )}

    {/* Content */}
    {post.content.rendered && (
      <div
        class="prose prose-invert prose-teal max-w-none mb-8"
        set:html={post.content.rendered}
      />
    )}

    {/* Prev/Next Navigation */}
    <nav class="mt-8 pt-6 border-t border-teal-800 flex justify-between gap-4">
      {prev ? (
        <a href={`/work/${prev.slug}`} class="group flex-1 text-left">
          <span class="text-teal-600 text-xs uppercase">Previous</span>
          <div class="text-teal-500 group-hover:text-yellow-500 transition-colors truncate">
            &larr; {prev.title}
          </div>
        </a>
      ) : (
        <div class="flex-1" />
      )}

      {next ? (
        <a href={`/work/${next.slug}`} class="group flex-1 text-right">
          <span class="text-teal-600 text-xs uppercase">Next</span>
          <div class="text-teal-500 group-hover:text-yellow-500 transition-colors truncate">
            {next.title} &rarr;
          </div>
        </a>
      ) : (
        <div class="flex-1" />
      )}
    </nav>

  </article>
</Base>
